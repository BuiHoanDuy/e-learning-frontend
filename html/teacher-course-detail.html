<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết khóa học (Giảng viên)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      #drop-zone {
        border: 2px dashed #007bff;
        border-radius: 5px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
      }
      #drop-zone.highlight {
        background-color: #f8f9fa;
        border-color: #28a745;
      }
      #file-input {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="teacher-home.html">E-Learning giáo viên</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="teacher-home.html">Trang chính</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html">Đăng xuất</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
          <div class="position-sticky">
            <h4 class="p-3">Khóa học của tôi</h4>
            <ul class="nav flex-column" id="course-list">
              <!-- Tự động cập nhật bằng JS -->
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div class="pt-4">
            <div class="d-flex justify-content-between align-items-center">
              <h2 id="course-title">Tên khóa học</h2>
              <div>
                <a href="#" class="btn btn-outline-primary btn-sm me-2"
                  >Chỉnh sửa khóa học</a
                >
                <a
                  href="#"
                  class="btn btn-success btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#addAssignmentModal"
                  >+ Thêm bài tập</a
                >
                <a
                  href="#"
                  class="btn btn-success btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#addLessonModal"
                >
                  + Thêm bài giảng
                </a>
              </div>
            </div>
            <p>
              <strong>Giảng viên:</strong>
              <span id="teacher-name">Đang tải...</span>
            </p>
            <p><strong>Ngày tạo:</strong> <span id="created-at">--</span></p>

            <hr />

            <h4>Thông tin khóa học</h4>
            <div class="list-group mb-4">
              <a
                href="course-announcements.html?id="
                id="announcements-link"
                class="list-group-item list-group-item-action"
                >Quản lý thông báo</a
              >
              <a
                href="course-forum.html?id="
                id="forum-link"
                class="list-group-item list-group-item-action"
                >Diễn đàn thảo luận</a
              >
              <a
                href="syllabus.html?id="
                id="syllabus-link"
                class="list-group-item list-group-item-action"
                >Đề cương môn học</a
              >
              <a
                href="course-content.html?id="
                id="content-link"
                class="list-group-item list-group-item-action"
                >Quản lý nội dung khóa học</a
              >
            </div>

            <h2 class="mt-4">Danh sách bài giảng</h2>
            <div id="lessonList" class="list-group">
              <div class="text-muted">Đang tải bài giảng...</div>
            </div>

            <h2 class="mt-4">Danh sách bài tập</h2>
            <div id="assignmentList" class="list-group">
              <div class="text-muted">Đang tải bài tập...</div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <footer class="text-light bg-primary py-3 mt-4">
      <div class="container text-center">
        <p><a href="#" class="text-light">✉ Liên hệ hỗ trợ</a></p>
        <p>
          Đăng nhập với tên
          <a href="login.html" class="text-light" id="username-display"
            >Đang tải...</a
          >
        </p>
        <p><a href="teacher-home.html" class="text-light">Trang chính</a></p>
      </div>
    </footer>
    <!-- Modal: Thêm bài tập -->
    <div
      class="modal fade"
      id="addAssignmentModal"
      tabindex="-1"
      aria-labelledby="addAssignmentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addAssignmentModalLabel">
              Thêm bài tập mới
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addAssignmentForm" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="assignmentTitle" class="form-label">Tiêu đề</label>
                <input
                  type="text"
                  class="form-control"
                  id="assignmentTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="assignmentContent" class="form-label"
                  >Mô tả bài tập</label
                >
                <textarea
                  class="form-control"
                  id="assignmentContent"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="assignmentDueDate" class="form-label"
                  >Hạn nộp</label
                >
                <input
                  type="datetime-local"
                  class="form-control"
                  id="assignmentDueDate"
                  required
                />
              </div>
              <div id="drop-zone" class="p-4 text-center">
                <p>
                  Kéo và thả tệp vào đây hoặc
                  <label for="file-input" style="color: blue; cursor: pointer"
                    >chọn tệp</label
                  >
                </p>
                <input type="file" id="file-input" multiple />
                <ul id="file-list" class="list-group mt-3"></ul>
              </div>
              <button type="submit" class="btn btn-primary mt-3 w-100">
                Tạo bài tập
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Thêm bài giảng -->
    <div
      class="modal fade"
      id="addLessonModal"
      tabindex="-1"
      aria-labelledby="addLessonModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addLessonModalLabel">
              Thêm bài giảng mới
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addLessonForm">
              <div class="mb-3">
                <label for="lessonTitle" class="form-label">Tiêu đề</label>
                <input
                  type="text"
                  class="form-control"
                  id="lessonTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="lessonContent" class="form-label">Nội dung</label>
                <textarea
                  class="form-control"
                  id="lessonContent"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="lessonVideoUrl" class="form-label"
                  >Video URL (tuỳ chọn)</label
                >
                <input type="url" class="form-control" id="lessonVideoUrl" />
              </div>
              <button type="submit" class="btn btn-primary">
                Tạo bài giảng
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const fullname = localStorage.getItem("fullname");
        const token = localStorage.getItem("token");
        const displayElement = document.getElementById("username-display");

        if (fullname && displayElement) {
          displayElement.textContent = `${fullname} (Thoát)`;
        }

        const params = new URLSearchParams(window.location.search);
        const courseId = params.get("id");
        if (!courseId) {
          alert("Không tìm thấy ID khóa học!");
          return;
        }

        // Cập nhật link có kèm courseId
        document.getElementById("announcements-link").href += courseId;
        document.getElementById("forum-link").href += courseId;
        document.getElementById("syllabus-link").href += courseId;
        document.getElementById("content-link").href += courseId;

        // Tải chi tiết khóa học
        fetch(`http://localhost:8080/elearning/courses/${courseId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200 && data.result) {
              const course = data.result;
              document.getElementById("course-title").textContent =
                course.courseName;
              document.getElementById("teacher-name").textContent =
                course.teacher?.fullName || "Không rõ";
              document.getElementById("created-at").textContent = new Date(
                course.createdAt
              ).toLocaleString("vi-VN");
            } else {
              alert("Không thể tải thông tin khóa học.");
            }
          });

        // Sidebar: danh sách khóa học
        fetch("http://localhost:8080/elearning/courses", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById("course-list");
            if (data.code === 200 && Array.isArray(data.result)) {
              data.result.forEach((c) => {
                const li = document.createElement("li");
                li.className = "nav-item";
                const a = document.createElement("a");
                a.className = "nav-link";
                a.href = `teacher-course-detail.html?id=${c.id}`;
                a.textContent = c.courseName;
                li.appendChild(a);
                list.appendChild(li);
              });
            } else {
              list.innerHTML =
                "<li class='nav-item text-danger p-2'>Không có khóa học.</li>";
            }
          });

        // Danh sách bài tập
        fetch(
          `http://localhost:8080/elearning/assignments/by-course/${courseId}`,
          {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        )
          .then((res) => res.json())
          .then((data) => {
            const assignmentList = document.getElementById("assignmentList");
            assignmentList.innerHTML = "";

            if (data.result && data.result.length > 0) {
              data.result.forEach((assignment) => {
                const link = document.createElement("a");
                link.href = `teacher-assignment-detail.html?id=${assignment.id}`;
                link.className = "list-group-item list-group-item-action";
                link.textContent = assignment.title;
                assignmentList.appendChild(link);
              });
            } else {
              assignmentList.innerHTML =
                '<div class="text-muted">Chưa có bài tập nào.</div>';
            }
          });
        // Danh sách bài giảng
        fetch(`http://localhost:8080/elearning/lessons/all/${courseId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const lessonList = document.getElementById("lessonList");
            lessonList.innerHTML = "";

            if (data.result && data.result.length > 0) {
              data.result.forEach((lesson) => {
                const item = document.createElement("a");
                item.href = `teacher-lesson-detail.html?id=${lesson.id}`;
                item.className = "list-group-item list-group-item-action";

                const title = document.createElement("h5");
                title.className = "mb-1";
                title.textContent = lesson.title;

                const videoLink = document.createElement("a");
                videoLink.href = lesson.videoUrl;
                videoLink.textContent = "Xem video";
                videoLink.target = "_blank";
                videoLink.className = "text-primary small";

                item.appendChild(title);
                if (lesson.videoUrl) {
                  item.appendChild(videoLink);
                }

                lessonList.appendChild(item);
              });
            } else {
              lessonList.innerHTML =
                '<div class="text-muted">Chưa có bài giảng nào.</div>';
            }
          })
          .catch(() => {
            const lessonList = document.getElementById("lessonList");
            lessonList.innerHTML =
              '<div class="text-danger">Không thể tải danh sách bài giảng.</div>';
          });

        // Thiết lập xử lý kéo thả file
        setupDragAndDropFiles();
        
        // Thiết lập form thêm bài tập
        setupAddAssignmentForm();
        
        // Thiết lập form thêm bài giảng
        setupAddLessonForm();
      });

      // Thiết lập kéo thả file
      function setupDragAndDropFiles() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        let filesToUpload = [];

        // Xử lý kéo thả
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Thêm hiệu ứng khi kéo file vào
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('highlight');
          });
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('highlight');
          });
        });

        // Xử lý khi thả file
        dropZone.addEventListener('drop', function(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles(files);
        });

        // Xử lý khi chọn file qua input
        fileInput.addEventListener('change', function() {
          handleFiles(this.files);
        });

        // Label khi click vào để mở file
        dropZone.addEventListener('click', function() {
          fileInput.click();
        });

        // Xử lý files được chọn
        function handleFiles(filesList) {
          Array.from(filesList).forEach(file => {
            filesToUpload.push(file);
          });
          renderFileList();
        }

        // Hiển thị danh sách file đã chọn
        function renderFileList() {
          fileList.innerHTML = '';
          filesToUpload.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = file.name;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.textContent = 'X';
            removeBtn.onclick = (e) => {
              e.preventDefault();
              filesToUpload.splice(index, 1);
              renderFileList();
            };

            li.appendChild(removeBtn);
            fileList.appendChild(li);
          });
        }

        // Trả về danh sách file để sử dụng trong form
        return {
          getFiles: () => filesToUpload,
          clearFiles: () => {
            filesToUpload = [];
            renderFileList();
          }
        };
      }

      // Thiết lập form thêm tiết học
      function setupAddLessonForm() {
        const addLessonForm = document.getElementById("addLessonForm");
        const token = localStorage.getItem("token");
        const params = new URLSearchParams(window.location.search);
        const courseId = params.get("id");

        addLessonForm.addEventListener("submit", function (e) {
          e.preventDefault();
          
          const title = document.getElementById("lessonTitle").value;
          const content = document.getElementById("lessonContent").value;
          const videoUrl = document.getElementById("lessonVideoUrl").value;

          fetch(`http://localhost:8080/elearning/lessons/${courseId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              title,
              content,
              videoUrl: videoUrl || null,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.code === 200) {
                alert("Thêm bài giảng thành công!");
                // Ẩn modal
                const modal = bootstrap.Modal.getInstance(document.getElementById("addLessonModal"));
                modal.hide();
                // Reload lại danh sách bài giảng
                location.reload();
              } else {
                alert(
                  "Không thể thêm bài giảng: " +
                    (data.message || "Lỗi không xác định")
                );
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Đã xảy ra lỗi khi thêm bài giảng.");
            });
        });
      }

      // Thiết lập form thêm bài tập
      function setupAddAssignmentForm() {
        const addAssignmentForm = document.getElementById("addAssignmentForm");
        const token = localStorage.getItem("token");
        const params = new URLSearchParams(window.location.search);
        const courseId = params.get("id");
        
        // Lấy fileHandler từ việc thiết lập kéo thả
        const fileHandler = {
          getFiles: function() {
            const fileInput = document.getElementById("file-input");
            return fileInput.files;
          }
        };

        addAssignmentForm.addEventListener("submit", function (e) {
          e.preventDefault();
          
          const title = document.getElementById("assignmentTitle").value;
          const description = document.getElementById("assignmentContent").value;
          
          // Định dạng ngày tháng đúng cách
          const dueDateInput = document.getElementById("assignmentDueDate").value;
          let dueDate = dueDateInput;
          
          // Thêm ':00' nếu chưa có seconds
          if (dueDate.split(':').length === 2) {
            dueDate = dueDate + ':00';
          }
          
          // ĐỔI PHƯƠNG THỨC: Sử dụng JSON thay vì FormData
          const assignmentData = {
            title: title,
            description: description,
            dueDate: dueDate
          };
          
          console.log("Gửi dữ liệu:", JSON.stringify(assignmentData));
          
          // Gửi dữ liệu bài tập (không bao gồm file) trước
          fetch(`http://localhost:8080/elearning/assignments/${courseId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(assignmentData)
          })
            .then(res => res.json())
            .then(data => {
              if (data.code === 200 || data.status === "success") {
                // Nếu tạo bài tập thành công, upload files nếu có
                const assignmentId = data.result?.id;
                if (assignmentId) {
                  const fileInput = document.getElementById("file-input");
                  if (fileInput.files.length > 0) {
                    uploadAssignmentFiles(assignmentId, fileInput.files);
                  } else {
                    finishAssignmentCreation();
                  }
                } else {
                  finishAssignmentCreation();
                }
              } else {
                alert("Lỗi khi tạo bài tập: " + (data.message || "Không xác định"));
              }
            })
            .catch(err => {
              console.error(err);
              alert("Đã xảy ra lỗi khi gửi dữ liệu bài tập.");
            });
        });
        
        // Hàm upload files cho bài tập
        function uploadAssignmentFiles(assignmentId, files) {
          const formData = new FormData();
          for (let i = 0; i < files.length; i++) {
            formData.append("files", files[i]);
          }
          
          fetch(`http://localhost:8080/elearning/assignments/${assignmentId}`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`
            },
            body: formData
          })
            .then(res => res.json())
            .then(data => {
              if (data.code === 200 || data.status === "success") {
                finishAssignmentCreation();
              } else {
                alert("Tạo bài tập thành công, nhưng không thể upload files: " + 
                      (data.message || "Không xác định"));
                location.reload();
              }
            })
            .catch(err => {
              console.error(err);
              alert("Tạo bài tập thành công, nhưng không thể upload files.");
              location.reload();
            });
        }
        
        // Hàm hoàn thành quá trình tạo bài tập
        function finishAssignmentCreation() {
          alert("Tạo bài tập thành công!");
          document.getElementById("addAssignmentForm").reset();
          document.getElementById("file-list").innerHTML = "";
          
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("addAssignmentModal")
          );
          modal.hide();
          
          location.reload();
        }
      }
    </script>
  </body>
</html>