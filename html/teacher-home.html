<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Giáo viên | E-Learning</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/tea-style.css " rel="stylesheet">
  </head>

  <body>
    <!-- Header  -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="teacher-home.html">E-Learning</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="teacher-home.html">
                <i class="fas fa-home me-1"></i> Trang chính
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="update-user.html">
                <i class="fas fa-user-circle me-1"></i> Hồ sơ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html">
                <i class="fas fa-sign-out-alt me-1"></i> Đăng xuất
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Layout -->
    <div class="container-fluid">
      <div class="row">
          <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar">
          <div class="position-sticky">
            <h4>
              <i class="fas fa-book"></i> Khóa học của tôi
            </h4>
            <ul class="nav flex-column" id="course-list">
              <!-- Tự động cập nhật bằng JS -->
              <li class="nav-item">
                <a class="nav-link" href="#">Đang tải danh sách...</a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 teacher-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2>Chào mừng, <strong id="teacher-name">Giáo viên</strong>!</h2>
              <p>Quản lý và theo dõi các khóa học của bạn từ bảng điều khiển này.</p>
            </div>
            <div class="d-none d-md-block">
              <button class="btn btn-primary btn-add-course" data-bs-toggle="modal" data-bs-target="#createCourseModal">
                <i class="fas fa-plus"></i> Tạo khóa học mới
              </button>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="row">
            <div class="col-md-4">
              <div class="stats-card position-relative">
                <i class="fas fa-book-open"></i>
                <h3 id="total-courses">0</h3>
                <p>Tổng số khóa học</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card position-relative">
                <i class="fas fa-users"></i>
                <h3 id="total-students">0</h3>
                <p>Tổng số học viên</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card position-relative">
                <i class="fas fa-clock"></i>
                <h3 id="active-courses">0</h3>
                <p>Khóa học đang hoạt động</p>
              </div>
            </div>
          </div>

          <div class="d-md-none mb-4 mt-2">
            <button class="btn btn-primary btn-add-course w-100" data-bs-toggle="modal" data-bs-target="#createCourseModal">
              <i class="fas fa-plus"></i> Tạo khóa học mới
            </button>
          </div>

          <h4><i class="fas fa-graduation-cap me-2"></i>Khóa học của bạn</h4>
          <div class="row" id="teacher-courses">
            <div class="col-12">
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3">Đang tải danh sách khóa học...</p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal tạo khóa học -->
    <div class="modal fade" id="createCourseModal" tabindex="-1" aria-labelledby="createCourseLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="createCourseForm">
            <div class="modal-header">
              <h5 class="modal-title" id="createCourseLabel"><i class="fas fa-plus-circle me-2"></i>Tạo khóa học mới</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="courseNameInput" class="form-label">Tên khóa học</label>
                <input type="text" class="form-control" id="courseNameInput" placeholder="Nhập tên khóa học" required />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-check me-1"></i> Tạo khóa học
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4">
      <div class="container">
        <p class="mb-0"><i class="fas fa-envelope me-1"></i> Hỗ trợ: <a href="#">elearning-support@example.com</a></p>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      // Load sidebar course list
      async function loadCourses() {
        const token = localStorage.getItem("token");
        const courseList = document.getElementById("course-list");

        try {
          const response = await fetch("http://localhost:8080/elearning/courses", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.code === 200 && Array.isArray(data.result)) {
            courseList.innerHTML = "";
            data.result.forEach((course) => {
              const li = document.createElement("li");
              li.className = "nav-item";

              const a = document.createElement("a");
              a.className = "nav-link";
              a.href = `teacher-course-detail.html?id=${course.id}`;
              a.innerHTML = `<i class="fas fa-book me-2"></i>${course.courseName}`;

              li.appendChild(a);
              courseList.appendChild(li);
            });

            // Cập nhật thống kê
            document.getElementById("total-courses").textContent = data.result.length;
            document.getElementById("active-courses").textContent = data.result.length; // Giả sử tất cả đều hoạt động
            
            // Tính tổng số học viên
            let totalStudents = 0;
            data.result.forEach(course => {
              totalStudents += course.student ? course.student.length : 0;
            });
            document.getElementById("total-students").textContent = totalStudents;
            
          } else {
            courseList.innerHTML = '<li class="nav-item"><a class="nav-link text-danger"><i class="fas fa-exclamation-circle me-2"></i>Không có khóa học nào.</a></li>';
            document.getElementById("total-courses").textContent = "0";
            document.getElementById("total-students").textContent = "0";
            document.getElementById("active-courses").textContent = "0";
          }
        } catch (error) {
          console.error("Lỗi khi tải khóa học:", error);
          courseList.innerHTML = '<li class="nav-item"><a class="nav-link text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Không thể tải danh sách.</a></li>';
        }
      }


      document.getElementById("teacher-name").textContent = localStorage.fullname || "Giáo viên";

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN", {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      async function loadTeacherDashboard() {
        loadCourses(); // cập nhật sidebar
        const token = localStorage.getItem("token");
        try {
          const response = await fetch("http://localhost:8080/elearning/courses", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();
          const courseContainer = document.getElementById("teacher-courses");
          courseContainer.innerHTML = "";

          if (data.code === 200 && data.result.length > 0) {
            data.result.forEach((course) => {
              const col = document.createElement("div");
              col.className = "col-md-6 col-lg-4 mb-4";

              const card = document.createElement("div");
              card.className = "card h-100 course-card";

              const cardBody = document.createElement("div");
              cardBody.className = "card-body";

              // Header với icon
              const headerDiv = document.createElement("div");
              headerDiv.className = "d-flex align-items-center mb-3";
              
              const icon = document.createElement("i");
              icon.className = "fas fa-graduation-cap course-icon";
              
              const titleDiv = document.createElement("div");
              
              const title = document.createElement("h5");
              title.className = "card-title mb-0";
              title.textContent = course.courseName;
              
              const statusBadge = document.createElement("div");
              statusBadge.className = "mt-1";
              statusBadge.innerHTML = '<span class="status-indicator status-active"></span> Hoạt động';
              
              titleDiv.appendChild(title);
              titleDiv.appendChild(statusBadge);
              
              headerDiv.appendChild(icon);
              headerDiv.appendChild(titleDiv);
              
              cardBody.appendChild(headerDiv);

              // Thông tin khóa học
              const infoContainer = document.createElement("div");
              infoContainer.className = "mb-3";

              const joinCode = document.createElement("p");
              joinCode.className = "card-subtitle mb-2 d-flex align-items-center";
              joinCode.innerHTML = `<i class="fas fa-key me-2 text-primary"></i> Mã tham gia: <strong class="ms-1">${course.joinCode ?? "Không có"}</strong>`;

              const numOfStudent = document.createElement("p");
              numOfStudent.className = "card-subtitle mb-2 d-flex align-items-center";
              numOfStudent.innerHTML = `<i class="fas fa-users me-2 text-primary"></i> Sinh viên: <strong class="ms-1">${course.student ? course.student.length : 0}</strong>`;

              const createdAt = document.createElement("p");
              createdAt.className = "card-subtitle d-flex align-items-center";
              createdAt.innerHTML = `<i class="fas fa-calendar-alt me-2 text-primary"></i> Ngày tạo: <strong class="ms-1">${formatDate(course.createdAt)}</strong>`;

              infoContainer.appendChild(joinCode);
              infoContainer.appendChild(numOfStudent);
              infoContainer.appendChild(createdAt);
              
              cardBody.appendChild(infoContainer);

              // Nút hành động
              const buttonContainer = document.createElement("div");
              buttonContainer.className = "mt-auto";
              
              const detailBtn = document.createElement("a");
              detailBtn.href = `teacher-course-detail.html?id=${course.id}`;
              detailBtn.className = "btn btn-primary";
              detailBtn.innerHTML = '<i class="fas fa-eye me-2"></i> Xem chi tiết';
              
              buttonContainer.appendChild(detailBtn);
              cardBody.appendChild(buttonContainer);

              card.appendChild(cardBody);
              col.appendChild(card);
              courseContainer.appendChild(col);
            });
          } else {
            courseContainer.innerHTML = `
              <div class="col-12">
                <div class="text-center py-5">
                  <i class="fas fa-book-open fa-3x text-secondary mb-3"></i>
                  <h5>Không có khóa học nào</h5>
                  <p class="text-muted">Hãy tạo khóa học đầu tiên của bạn bằng cách nhấn nút "Tạo khóa học mới" ở trên.</p>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error("Lỗi khi tải dashboard:", error);
          document.getElementById("teacher-courses").innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i> Không thể tải dữ liệu khóa học. Vui lòng kiểm tra kết nối và thử lại.
              </div>
            </div>
          `;
        }
      }

      document.getElementById("createCourseForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const courseName = document.getElementById("courseNameInput").value.trim();
        const token = localStorage.getItem("token");

        if (!courseName) return alert("Vui lòng nhập tên khóa học.");

        // Thay đổi nút submit để hiển thị trạng thái đang xử lý
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Đang xử lý...';

        try {
          const response = await fetch("http://localhost:8080/elearning/courses", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ courseName }),
          });

          const result = await response.json();

          if (result.code === 201 || result.code === 200) {
            // Thông báo thành công
            const alertHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i> Tạo khóa học thành công!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            
            document.querySelector('main').insertAdjacentHTML('afterbegin', alertHTML);
            
            document.getElementById("createCourseForm").reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById("createCourseModal"));
            modal.hide();
            loadTeacherDashboard();
          } else {
            alert("Lỗi: " + (result.message || "Không thể tạo khóa học."));
          }
        } catch (error) {
          console.error("Lỗi khi tạo khóa học:", error);
          alert("Đã xảy ra lỗi khi tạo khóa học.");
        } finally {
          // Phục hồi nút submit
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      window.onload = loadTeacherDashboard;
    </script>
  </body>
</html>