<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt b√†i gi·∫£ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .card-lesson {
        background: #fff;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 40px;
      }
      iframe {
        border-radius: 12px;
      }
      .edit-btn {
        position: absolute;
        top: 30px;
        right: 30px;
      }
      .edit-btn button {
        background-color: #0d6efd;
        color: white;
      }
    </style>
  </head>
  <body>
   <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="home.html">E-Learning</a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="home.html">Trang ch·ªß</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">ƒêƒÉng xu·∫•t</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main layout with sidebar and content -->
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 d-md-block bg-light sidebar min-vh-100">
        <div class="position-sticky">
          <h4 class="p-3">Kh√≥a h·ªçc c·ªßa t√¥i</h4>
          <ul class="nav flex-column" id="course-list">
            <!-- Sidebar course list will be injected here -->
          </ul>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="col-md-10 ms-sm-auto px-4">
        <div class="position-relative">
          <div class="edit-btn d-none" id="edit-btn">
            <button class="btn btn-sm" onclick="showEditModal()">‚úè Ch·ªânh s·ª≠a</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="confirmDelete()">üóë X√≥a</button>
          </div>

          <div class="card-lesson">
            <h2 id="lesson-title">ƒêang t·∫£i ti√™u ƒë·ªÅ...</h2>
            <p class="text-muted"><strong>Ng√†y t·∫°o:</strong> <span id="created-at">--</span></p>

            <div class="mt-4">
              <h5 class="text-primary">üìö N·ªôi dung b√†i gi·∫£ng</h5>
              <p id="lesson-content" class="fs-5">ƒêang t·∫£i n·ªôi dung...</p>
            </div>

            <div id="video-section" class="mt-4">
              <h5 class="text-primary">üé¨ Video b√†i gi·∫£ng</h5>
              <div id="video-container" class="ratio ratio-16x9"></div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-light bg-dark py-4 mt-5">
    <div class="container text-center">
      <p><a href="#" class="text-light">‚úâ H·ªó tr·ª£ k·ªπ thu·∫≠t</a></p>
      <p>ƒêƒÉng nh·∫≠p v·ªõi t√™n: <a href="login.html" class="text-light" id="username-display">ƒêang t·∫£i...</a></p>
    </div>
  </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
 // Load sidebar course list
    async function loadCourses() {
        const token = localStorage.getItem("token");
        const courseList = document.getElementById("course-list");

        try {
          const response = await fetch("http://localhost:8080/elearning/courses", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.code === 200 && Array.isArray(data.result)) {
            courseList.innerHTML = "";
            data.result.forEach((course) => {
              const li = document.createElement("li");
              li.className = "nav-item";

              const a = document.createElement("a");
              a.className = "nav-link";
              a.href = `course-detail.html?id=${course.id}`;
              a.textContent = course.courseName;

              li.appendChild(a);
              courseList.appendChild(li);
            });
          } else {
            courseList.innerHTML = "<li class='nav-item text-danger p-2'>Kh√¥ng c√≥ kh√≥a h·ªçc n√†o.</li>";
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i kh√≥a h·ªçc:", error);
          courseList.innerHTML =
            "<li class='nav-item text-danger p-2'>Kh√¥ng th·ªÉ t·∫£i danh s√°ch kh√≥a h·ªçc.</li>";
        }
      }

      let currentLessonId;
      let currentLessonData;

      document.addEventListener("DOMContentLoaded", () => {
        loadCourses(); // c·∫≠p nh·∫≠t sidebar
        const token = localStorage.getItem("token");
        const fullname = localStorage.getItem("fullname");
        const roles = JSON.parse(localStorage.getItem("roles"));
        const displayElement = document.getElementById("username-display");
        if (fullname && displayElement) displayElement.textContent = `${fullname} (Tho√°t)`;

        const isTeacher = roles && roles[0]?.name === "TEACHER";
        if (isTeacher) document.getElementById("edit-btn").classList.remove("d-none");

        const params = new URLSearchParams(window.location.search);
        currentLessonId = params.get("id");
console.log(currentLessonId);
        if (!currentLessonId) {
          alert("Kh√¥ng t√¨m th·∫•y b√†i gi·∫£ng!");
          return;
        }

        fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200 && data.result) {
              const lesson = data.result;
              currentLessonData = lesson;
              document.getElementById("lesson-title").textContent = lesson.title;
              document.getElementById("lesson-content").textContent = lesson.content;
              document.getElementById("created-at").textContent = new Date(lesson.createdAt).toLocaleString("vi-VN");

              const videoContainer = document.getElementById("video-container");
              if (lesson.videoUrl?.includes("youtube.com")) {
                const videoId = lesson.videoUrl.split("v=")[1];
                videoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
              } else if (lesson.videoUrl) {
                videoContainer.innerHTML = `<a href="${lesson.videoUrl}" target="_blank">Xem video t·∫°i ƒë√¢y</a>`;
              } else {
                document.getElementById("video-section").innerHTML = '<p class="text-muted">Kh√¥ng c√≥ video.</p>';
              }
            } else {
              alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b√†i gi·∫£ng.");
            }
          })
          .catch((err) => {
            console.error(err);
            alert("L·ªói khi t·∫£i b√†i gi·∫£ng.");
          });
      });

      function showEditModal() {
        if (!currentLessonData) return;
        document.getElementById("edit-title").value = currentLessonData.title || "";
        document.getElementById("edit-content").value = currentLessonData.content || "";
        document.getElementById("edit-video").value = currentLessonData.videoUrl || "";

        const modal = new bootstrap.Modal(document.getElementById("editModal"));
        modal.show();
      }
      function confirmDelete() {
  if (!currentLessonId) return;
  const confirmResult = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i gi·∫£ng n√†y kh√¥ng?");
  if (!confirmResult) return;

  const token = localStorage.getItem("token");

  fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${token}`,
    },
  })
    .then((res) => {
      if (res.ok) {
        alert("ƒê√£ x√≥a b√†i gi·∫£ng th√†nh c√¥ng.");
        window.location.href = "teacher-course-detail.html"; // chuy·ªÉn v·ªÅ trang ch·ªß ho·∫∑c danh s√°ch b√†i gi·∫£ng
      } else {
        return res.json().then((data) => {
          throw new Error(data.message || "X√≥a b√†i gi·∫£ng th·∫•t b·∫°i.");
        });
      }
    })
    .catch((err) => {
      console.error(err);
      alert("L·ªói khi x√≥a b√†i gi·∫£ng: " + err.message);
    });
}

      document.getElementById("editForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const token = localStorage.getItem("token");

        const updatedLesson = {
          title: document.getElementById("edit-title").value,
          content: document.getElementById("edit-content").value,
          videoUrl: document.getElementById("edit-video").value,
        };

        fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(updatedLesson),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200) {
              alert("C·∫≠p nh·∫≠t b√†i gi·∫£ng th√†nh c√¥ng!");
              location.reload(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i th√¥ng tin
            } else {
              alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + data.message);
            }
          })
          .catch((err) => {
            console.error(err);
            alert("L·ªói khi c·∫≠p nh·∫≠t b√†i gi·∫£ng.");
          });
      });
    </script>
  </body>
</html>
