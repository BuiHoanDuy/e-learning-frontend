<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết khóa học | E-Learning</title>
    
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/stu-course.css" rel="stylesheet">

  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-book me-2"></i>E-Learning
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="home.html">
                <i class="bi bi-house-door me-1"></i>Trang chủ
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html">
                <i class="bi bi-box-arrow-right me-1"></i>Đăng xuất
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 sidebar">
          <div class="position-sticky">
            <h4 class="p-3">
              <i class="bi bi-journal-check me-2"></i>Khóa học của tôi
            </h4>
            <ul class="nav flex-column" id="course-list">
              <!-- Tự động cập nhật bằng JS -->
              <li class="nav-item">
                <div class="d-flex justify-content-center p-3">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
          <div class="breadcrumb-wrapper">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="home.html">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="courses.html">Khóa học</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-title">Chi tiết khóa học</li>
              </ol>
            </nav>
          </div>
          
          <div class="course-header">
            <h2 class="course-title" id="course-title">Đang tải khóa học...</h2>
            
            <div class="course-meta">
              <div class="teacher-info">
                <div class="teacher-avatar" id="teacher-avatar">?</div>
                <span id="teacher-name">Đang tải...</span>
              </div>
              
              <div class="course-meta-item">
                <i class="bi bi-calendar-date"></i>
                <span id="created-at">--</span>
              </div>
              
              <div class="course-meta-item">
                <i class="bi bi-key"></i>
                <span id="course-code">--</span>
              </div>
            </div>
          </div>

          <div class="section-card">
            <h4 class="section-title">
              <i class="bi bi-info-circle"></i>Thông tin khóa học
            </h4>
            <div class="list-group mb-4 info-list">
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-megaphone me-2"></i>Các thông báo
              </a>
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-chat-dots me-2"></i>Diễn đàn thảo luận
              </a>
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-file-earmark-text me-2"></i>Đề cương môn học
              </a>
            </div>
          </div>

          <div class="section-card">
            <h4 class="section-title">
              <i class="bi bi-collection-play"></i>Danh sách bài giảng
            </h4>
            <div id="lessonList" class="list-group">
              <div class="d-flex justify-content-center p-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <div class="section-card">
            <h4 class="section-title">
              <i class="bi bi-pencil-square"></i>Bài tập
            </h4>
            <div id="assignmentList" class="list-group">
              <div class="d-flex justify-content-center p-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <footer class="text-light py-4 mt-5">
      <div class="container text-center">
        <p>
          <a href="#" class="text-light footer-link">
            <i class="bi bi-envelope me-1"></i>Liên hệ hỗ trợ
          </a>
        </p>
        <p>
          Bạn đang đăng nhập với tên
          <a href="login.html" class="text-light footer-link" id="username-display">
            <i class="bi bi-person-circle me-1"></i>Đang tải...
          </a>
        </p>
        <p>
          <a href="home.html" class="text-light footer-link">
            <i class="bi bi-house-door me-1"></i>Trang chủ
          </a>
        </p>
      </div>
    </footer>

    <script>
      // Get teacher initials for avatar
      function getInitials(name) {
        if (!name) return "?";
        return name
          .split(' ')
          .map(word => word[0])
          .join('')
          .substring(0, 2)
          .toUpperCase();
      }
      
      // Format date helper function
      function formatDate(isoDate) {
        const date = new Date(isoDate);
        const options = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        };
        return date.toLocaleString("vi-VN", options);
      }
      
      document.addEventListener("DOMContentLoaded", function () {
        const fullname = localStorage.getItem("fullname");
        const displayElement = document.getElementById("username-display");

        if (fullname && displayElement) {
          displayElement.textContent = `${fullname} (Thoát)`;
        } else {
          displayElement.textContent = "Khách (Thoát)";
        }

        const token = localStorage.getItem("token");

        // Lấy courseId từ URL
        const params = new URLSearchParams(window.location.search);
        const courseId = params.get("id");

        if (!courseId) {
          alert("Không tìm thấy ID khóa học!");
          return;
        }
        localStorage.setItem("courseId", courseId);
        // Load course details
        fetch(`http://localhost:8080/elearning/courses/${courseId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200 && data.result) {
              const course = data.result;
              
              // Update course info
              document.getElementById("course-title").textContent = course.courseName;
              document.getElementById("breadcrumb-title").textContent = course.courseName;
              
              // Update teacher info
              const teacherName = course.teacher?.fullName || "Không rõ";
              document.getElementById("teacher-name").textContent = teacherName;
              document.getElementById("teacher-avatar").textContent = getInitials(teacherName);
              
              // Update dates
              document.getElementById("created-at").textContent = formatDate(course.createdAt);
              
              // Update course code
              document.getElementById("course-code").textContent = `Mã lớp: ${course.joinCode || "N/A"}`;
              
              // Add title to document
              document.title = `${course.courseName} | E-Learning`;
            } else {
              alert("Không thể tải thông tin khóa học.");
            }
          })
          .catch((error) => {
            console.error("Lỗi khi tải chi tiết khóa học:", error);
            alert("Lỗi khi tải thông tin khóa học.");
          });

        // Tải danh sách khóa học sidebar
        fetch("http://localhost:8080/elearning/courses", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById("course-list");
            if (data.code === 200 && Array.isArray(data.result)) {
              list.innerHTML = "";
              
              if (data.result.length === 0) {
                list.innerHTML = `
                  <li class="nav-item">
                    <div class="empty-state">
                      <i class="bi bi-journal-x"></i>
                      <p>Bạn chưa tham gia khóa học nào</p>
                    </div>
                  </li>
                `;
                return;
              }
              
              data.result.forEach((c) => {
                const li = document.createElement("li");
                li.className = "nav-item";
                
                const a = document.createElement("a");
                a.className = c.id === courseId ? "nav-link active" : "nav-link";
                a.href = `course-detail.html?id=${c.id}`;
                a.innerHTML = `<i class="bi bi-journal me-2"></i>${c.courseName}`;
                
                li.appendChild(a);
                list.appendChild(li);
              });
            } else {
              list.innerHTML =
                "<li class='nav-item text-danger p-2'><i class='bi bi-exclamation-circle me-2'></i>Không có khóa học.</li>";
            }
          })
          .catch(error => {
            console.error("Lỗi khi tải danh sách khóa học:", error);
            const list = document.getElementById("course-list");
            list.innerHTML = 
              "<li class='nav-item text-danger p-2'><i class='bi bi-exclamation-circle me-2'></i>Không thể tải danh sách khóa học.</li>";
          });

        // Danh sách bài giảng
        fetch(`http://localhost:8080/elearning/lessons/all/${courseId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const lessonList = document.getElementById("lessonList");
            lessonList.innerHTML = "";

            if (data.result && data.result.length > 0) {
              data.result.forEach((lesson) => {
                const item = document.createElement("a");
                item.href = `lesson-detail.html?id=${lesson.id}`;
                item.className = "list-group-item list-group-item-action lesson-item";

                const title = document.createElement("h5");
                title.className = "mb-1";
                title.textContent = lesson.title;

                item.appendChild(title);
                
                // Add video badge if exists
                if (lesson.videoUrl) {
                  const badge = document.createElement("span");
                  badge.className = "video-badge";
                  badge.innerHTML = `<i class="bi bi-play-circle"></i> Video`;
                  item.appendChild(badge);
                }

                lessonList.appendChild(item);
              });
            } else {
              lessonList.innerHTML = `
                <div class="empty-state">
                  <i class="bi bi-journal-x"></i>
                  <p>Chưa có bài giảng nào.</p>
                </div>
              `;
            }
          })
          .catch(() => {
            const lessonList = document.getElementById("lessonList");
            lessonList.innerHTML = `
              <div class="empty-state text-danger">
                <i class="bi bi-exclamation-circle"></i>
                <p>Không thể tải danh sách bài giảng.</p>
              </div>
            `;
          });
          
        //Lấy danh sách bài tập
        const apiUrl = `http://localhost:8080/elearning/assignments/by-course/${courseId}`;
        const assignmentList = document.getElementById("assignmentList");

        fetch(apiUrl, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            assignmentList.innerHTML = ""; // Clear loading text
            
            if (data.result && data.result.length > 0) {
              data.result.forEach((assignment) => {
                const link = document.createElement("a");
                link.href = `assignment-detail.html?id=${assignment.id}`;
                link.className = "list-group-item list-group-item-action assignment-item";
                link.innerHTML = `
                  <i class="bi bi-file-earmark-text"></i>
                  <span>${assignment.title}</span>
                `;
                assignmentList.appendChild(link);
              });
            } else {
              assignmentList.innerHTML = `
                <div class="empty-state">
                  <i class="bi bi-clipboard-x"></i>
                  <p>Chưa có bài tập nào.</p>
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Lỗi khi tải bài tập:", error);
            assignmentList.innerHTML = `
              <div class="empty-state text-danger">
                <i class="bi bi-exclamation-circle"></i>
                <p>Không thể tải danh sách bài tập.</p>
              </div>
            `;
          });
      });
    </script>
  </body>
</html>