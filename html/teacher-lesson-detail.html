<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết bài giảng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/tea-lesson.css">
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="teacher-home.html">
          <i class="fas fa-graduation-cap me-2"></i>E-Learning
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="teacher-home.html"><i class="fas fa-home me-1"></i> Trang chủ</a></li>
            <li class="nav-item"><a class="nav-link" href="login.html"><i class="fas fa-sign-out-alt me-1"></i> Đăng xuất</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main layout with sidebar and content -->
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
          <div class="position-sticky">
            <h4><i class="fas fa-book-open"></i> Khóa học của tôi</h4>
            <ul class="nav flex-column" id="course-list">
              <!-- Sidebar course list will be injected here -->
              <li class="nav-item">
                <a class="nav-link" href="#"><span class="placeholder col-9"></span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#"><span class="placeholder col-10"></span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#"><span class="placeholder col-8"></span></a>
              </li>
            </ul>
          </div>
        </nav>
   
        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
          <div class="position-relative">
            <div class="edit-btn d-none" id="edit-btn">
              <button class="btn btn-sm btn-edit me-2" onclick="showEditModal()">
                <i class="fas fa-pencil-alt me-1"></i> Chỉnh sửa
              </button>
              <button class="btn btn-sm btn-delete" onclick="confirmDelete()">
                <i class="fas fa-trash-alt me-1"></i> Xóa
              </button>
            </div>

            <div class="card-lesson">
              <div class="lesson-header">
                <h2 id="lesson-title" class="mb-3">Đang tải tiêu đề...</h2>
                <span class="date-badge"><i class="far fa-calendar-alt me-1"></i> <span id="created-at">--</span></span>
              </div>

              <div class="mt-4">
                <h5 class="section-title"><i class="fas fa-book"></i> Nội dung bài giảng</h5>
                <div id="lesson-content" class="fs-5 content-area">Đang tải nội dung...</div>
              </div>

              <div id="video-section" class="mt-4">
                <h5 class="section-title"><i class="fas fa-video"></i> Video bài giảng</h5>
                <div id="video-container" class="ratio ratio-16x9"></div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="editForm">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Chỉnh sửa bài giảng</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-bold"><i class="fas fa-heading me-1"></i> Tiêu đề</label>
                <input type="text" class="form-control" id="edit-title" required />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold"><i class="fas fa-align-left me-1"></i> Nội dung</label>
                <textarea class="form-control" rows="8" id="edit-content" required style="white-space: pre-wrap; font-family: 'Montserrat', sans-serif;"></textarea>
                <small class="text-muted"><i class="fas fa-info-circle me-1"></i> Định dạng văn bản như xuống dòng, dấu cách sẽ được giữ nguyên.</small>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold"><i class="fas fa-link me-1"></i> Video URL</label>
                <input type="url" class="form-control" id="edit-video" placeholder="https://www.youtube.com/watch?v=..." />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Hủy</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Lưu thay đổi</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-light py-4 mt-5">
      <div class="container text-center">
        <p><a href="#" class="text-light footer-link"><i class="fas fa-headset me-1"></i> Hỗ trợ kỹ thuật</a></p>
        <p>Đăng nhập với tên: <a href="login.html" class="text-light footer-link" id="username-display"><span class="placeholder col-4"></span></a></p>
        <p><a href="teacher-home.html" class="text-light footer-link"><i class="fas fa-home me-1"></i> Trang chính</a></p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load sidebar course list
      async function loadCourses() {
        const token = localStorage.getItem("token");
        const courseList = document.getElementById("course-list");
        const courseId = localStorage.getItem("courseId");
        try {
          const response = await fetch("http://localhost:8080/elearning/courses", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.code === 200 && Array.isArray(data.result)) {
            courseList.innerHTML = "";
            data.result.forEach((c) => {
              const li = document.createElement("li");
              li.className = "nav-item";

              const a = document.createElement("a");
              a.className = c.id === courseId ? "nav-link active" : "nav-link";
              a.href = `teacher-course-detail.html?id=${c.id}`;
              a.textContent = c.courseName;

              li.appendChild(a);
              courseList.appendChild(li);
            });
          } else {
            courseList.innerHTML = "<li class='nav-item'><span class='nav-link text-danger'><i class='fas fa-exclamation-circle me-2'></i>Không có khóa học nào.</span></li>";
          }
        } catch (error) {
          console.error("Lỗi khi tải khóa học:", error);
          courseList.innerHTML =
            "<li class='nav-item'><span class='nav-link text-danger'><i class='fas fa-exclamation-triangle me-2'></i>Không thể tải danh sách khóa học.</span></li>";
        }
      }

      let currentLessonId;
      let currentLessonData;

      document.addEventListener("DOMContentLoaded", () => {
        loadCourses(); // cập nhật sidebar
        const token = localStorage.getItem("token");
        const fullname = localStorage.getItem("fullname");
        const roles = JSON.parse(localStorage.getItem("roles"));
        const displayElement = document.getElementById("username-display");
        if (fullname && displayElement) displayElement.textContent = `${fullname} (Thoát)`;

        const isTeacher = roles && roles[0]?.name === "TEACHER";
        if (isTeacher) document.getElementById("edit-btn").classList.remove("d-none");

        const params = new URLSearchParams(window.location.search);
        currentLessonId = params.get("id");
        console.log(currentLessonId);
        
        if (!currentLessonId) {
          alert("Không tìm thấy bài giảng!");
          return;
        }

        fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200 && data.result) {
              const lesson = data.result;
              currentLessonData = lesson;
              document.getElementById("lesson-title").textContent = lesson.title;
              document.getElementById("lesson-content").textContent = lesson.content;
              document.getElementById("created-at").textContent = new Date(lesson.createdAt).toLocaleString("vi-VN");

              const videoContainer = document.getElementById("video-container");
              if (lesson.videoUrl?.includes("youtube.com")) {
                const videoId = lesson.videoUrl.split("v=")[1];
                videoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
              } else if (lesson.videoUrl) {
                videoContainer.innerHTML = `<a href="${lesson.videoUrl}" target="_blank" class="btn btn-outline-primary"><i class="fas fa-external-link-alt me-2"></i>Xem video tại đây</a>`;
              } else {
                document.getElementById("video-section").innerHTML = '<p class="text-muted"><i class="fas fa-info-circle me-2"></i>Không có video cho bài giảng này.</p>';
              }
            } else {
              alert("Không thể tải thông tin bài giảng.");
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Lỗi khi tải bài giảng.");
          });
      });

      function showEditModal() {
        if (!currentLessonData) return;
        document.getElementById("edit-title").value = currentLessonData.title || "";
        document.getElementById("edit-content").value = currentLessonData.content || "";
        document.getElementById("edit-video").value = currentLessonData.videoUrl || "";

        const modal = new bootstrap.Modal(document.getElementById("editModal"));
        modal.show();
      }
      
      function confirmDelete() {
        if (!currentLessonId) return;
        const confirmResult = confirm("Bạn có chắc chắn muốn xóa bài giảng này không?");
        if (!confirmResult) return;

        const token = localStorage.getItem("token");

        fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => {
            if (res.ok) {
              alert("Đã xóa bài giảng thành công.");
              window.location.href = "teacher-course-detail.html"; // chuyển về trang chủ hoặc danh sách bài giảng
            } else {
              return res.json().then((data) => {
                throw new Error(data.message || "Xóa bài giảng thất bại.");
              });
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Lỗi khi xóa bài giảng: " + err.message);
          });
      }

      document.getElementById("editForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const token = localStorage.getItem("token");

        const updatedLesson = {
          title: document.getElementById("edit-title").value,
          content: document.getElementById("edit-content").value,
          videoUrl: document.getElementById("edit-video").value,
        };

        fetch(`http://localhost:8080/elearning/lessons/${currentLessonId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(updatedLesson),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.code === 200) {
              alert("Cập nhật bài giảng thành công!");
              location.reload(); // Reload để cập nhật lại thông tin
            } else {
              alert("Cập nhật thất bại: " + data.message);
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Lỗi khi cập nhật bài giảng.");
          });
      });
    </script>
  </body>
</html>